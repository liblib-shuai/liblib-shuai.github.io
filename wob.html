<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ¨¡å‹ç›²æµ‹å¹³å°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* åŠ è½½åŠ¨ç”»æ ·å¼ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 32px;
            color: #2d3748;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        /* åŠŸèƒ½é€‰æ‹©å™¨æ ·å¼ */
        .function-selector {
            margin-bottom: 25px;
        }
        .function-tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 15px;
        }
        .function-tab {
            background: none;
            border: none;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #718096;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .function-tab:hover {
            background: #f7fafc;
            color: #4a5568;
        }
        .function-tab.active {
            background: #f7fafc;
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .function-content {
            padding-top: 20px;
        }
        .file-input-group {
            margin-bottom: 20px;
        }
        .file-input { display: none; }
        .file-label {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .file-list {
            margin-top: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
            background: #f8fafc;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-item:hover {
            background: #f1f5f9;
        }
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        .file-name {
            font-weight: 500;
            color: #2d3748;
        }
        .file-size {
            color: #718096;
            font-size: 14px;
        }
        .file-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .file-status.success {
            background: #c6f6d5;
            color: #22543d;
        }
        .file-status.error {
            background: #fed7d7;
            color: #742a2a;
        }
        .file-status.loading {
            background: #bee3f8;
            color: #2a4365;
        }
        .delete-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .delete-btn:hover {
            background: #c53030;
            transform: scale(1.05);
        }
        .add-file-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        .add-file-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }
        .start-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }
        .start-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .test-section {
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .test-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .home-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .home-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .results-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .results-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .test-info {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .info-label {
            font-weight: 500;
            color: #4a5568;
            font-size: 14px;
        }
        .info-value {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .test-content { padding: 30px; }
        .input-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .input-text {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            font-size: 16px;
            line-height: 1.6;
        }
        .input-images {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .input-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s ease;
            position: relative;
        }
        .input-image:hover { 
            transform: scale(1.05); 
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .input-image::after {
            content: 'ğŸ”';
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px;
            border-radius: 50%;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .input-image:hover::after {
            opacity: 1;
        }
        .output-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .output-grid.single-item {
            max-width: 600px;
            margin: 0 auto;
        }
        .output-grid.single-item .output-item {
            min-height: 300px;
        }
        .output-grid.single-item .media-container {
            min-height: 200px;
        }
        .output-grid.single-item .output-image {
            height: auto;
        }
        .output-item {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            min-height: 300px;
            max-height: 800px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .output-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .output-item.selected {
            border-color: #48bb78;
            background: #f0fff4;
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.2);
        }
        .output-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .output-image[src*=".mp4"], video.output-image {
            object-fit: contain;
            background: #f7fafc;
        }
        .media-container {
            position: relative;
            cursor: pointer;
            margin-bottom: 15px;
            min-height: 200px;
            max-height: 600px;
            border-radius: 8px;
            overflow: hidden;
        }
        .media-container:last-child {
            margin-bottom: 0;
        }
        .media-container .output-image {
            width: 100%;
            height: auto;
            object-fit: contain;
        }
        .media-container video.output-image {
            object-fit: contain;
            background: #f7fafc;
        }
        
        /* ç¼©ç•¥å›¾æ ·å¼ */
        .thumbnail-container {
            position: relative;
            width: 100%;
            min-height: 200px;
            max-height: 600px;
            background: #f7fafc;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .thumbnail-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: all 0.3s ease;
            filter: blur(2px);
            transform: scale(1.1);
        }
        
        .thumbnail-image.loaded {
            filter: blur(0);
            transform: scale(1);
        }
        
        
        
        
        .full-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .full-image.loaded {
            opacity: 1;
        }
        
        .media-scroll-container {
            flex: 1;
            overflow-y: auto;
            max-height: 700px;
            padding-right: 5px;
        }
        .media-scroll-container::-webkit-scrollbar {
            width: 6px;
        }
        .media-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .media-scroll-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        .media-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .media-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 8px;
        }
        .media-container:hover .media-overlay {
            opacity: 1;
        }
        .zoom-icon {
            color: white;
            font-size: 24px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 50%;
        }
        .output-info {
            text-align: center;
            font-weight: 500;
            color: #4a5568;
            margin-top: 10px;
            flex-shrink: 0;
        }
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            gap: 20px;
        }
        .preference-reason-section {
            flex: 1;
            max-width: 600px;
        }
        .preference-reason-label {
            display: block;
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .preference-reason-textarea {
            width: 100%;
            min-height: 50px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
            background: white;
        }
        .preference-reason-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .preference-reason-textarea::placeholder {
            color: #a0aec0;
        }
        .nav-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .prev-btn {
            background: #718096;
            color: white;
        }
        .next-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .next-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .results-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .results-nav {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        .results-nav .home-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .results-nav .home-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .progress-overview {
            margin-bottom: 20px;
        }
        .progress-bar-container {
            height: 20px;
            background-color: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #48bb78;
            transition: width 0.3s ease;
        }
        .progress-text {
            text-align: center;
            font-weight: 500;
            color: #4a5568;
        }
        .model-comparison {
            margin-bottom: 20px;
        }
        .chart-container {
            height: 300px;
            background-color: #f7fafc;
            border-radius: 8px;
            overflow: hidden;
        }
        .elo-ranking {
            margin-bottom: 20px;
        }
        .elo-container {
            background-color: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }
        .elo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .elo-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .elo-item:last-child {
            margin-bottom: 0;
        }
        .elo-rank {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .rank-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
        }
        .rank-1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0 0%, #e5e5e5 100%); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #daa520 100%); }
        .rank-other { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .model-name {
            font-weight: 500;
            color: #2d3748;
        }
        .elo-score {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .score-value {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        .score-change {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
        .score-positive {
            background: #c6f6d5;
            color: #22543d;
        }
        .score-negative {
            background: #fed7d7;
            color: #742a2a;
        }
        .score-neutral {
            background: #e2e8f0;
            color: #4a5568;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .results-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .action-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .export-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .output-grid { grid-template-columns: 1fr; }
            .test-header { flex-direction: column; gap: 10px; }
            .test-controls { 
                flex-direction: column; 
                gap: 10px; 
                width: 100%;
            }
            .test-controls .nav-btn {
                width: 100%;
                margin: 0;
            }
            .navigation-buttons { flex-direction: column; gap: 15px; }
            .test-info { 
                flex-direction: column; 
                gap: 10px; 
            }
            .results-actions {
                flex-direction: column;
                gap: 10px;
            }
            .results-nav {
                justify-content: center;
            }
            .results-nav .home-btn {
                width: 100%;
                max-width: 200px;
            }
        }
        .media-modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-height: 80%;
            overflow: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close-btn {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-body {
            text-align: center;
        }
        .modal-body img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .output-section {
            margin-bottom: 30px;
        }
        .keyboard-hint {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 14px;
            text-align: center;
        }
        .cache-controls {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .cache-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .cache-btn:hover {
            background: #c53030;
            transform: translateY(-1px);
        }
        .cache-info {
            margin-top: 10px;
            font-size: 14px;
            color: #4a5568;
        }
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }
        .detailed-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .model-detail {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .choice-details {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }
        .choice-item {
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
            margin-bottom: 10px;
        }
        .choice-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        /* æµ‹è¯•è¯¦æƒ…é€‰æ‹©æ¨¡æ€æ¡†æ ·å¼ */
        .test-detail-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .test-detail-modal .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .test-detail-modal .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-detail-modal .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .test-detail-modal .modal-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .test-navigation h4 {
            margin: 0 0 20px 0;
            color: #2d3748;
            font-size: 18px;
        }
        
        .test-list {
            display: grid;
            gap: 15px;
        }
        
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
        }
        
        .test-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        
        .test-item.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .test-item.incomplete {
            border-color: #ed8936;
            background: #fffaf0;
        }
        
        .test-info {
            flex: 1;
        }
        
        .test-number {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .test-id {
            font-size: 14px;
            color: #718096;
            margin-bottom: 5px;
        }
        
        .test-models {
            font-size: 16px;
            color: #4a5568;
            font-weight: 500;
        }
        
        .test-status {
            text-align: right;
        }
        
        .status-text {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .test-item.completed .status-text {
            color: #22543d;
        }
        
        .test-item.incomplete .status-text {
            color: #744210;
        }
        
        .selected-model {
            font-size: 12px;
            color: #718096;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }
        
        /* å¯¼å…¥ç»“æœè¯¦æƒ…æ ·å¼ */
        .imported-result-details {
            padding: 20px 0;
        }
        
        .imported-result-details h4 {
            color: #2d3748;
            margin: 20px 0 15px 0;
            font-size: 18px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }
        
        .result-overview {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 20px;
        }
        
        .result-overview p {
            margin: 8px 0;
            color: #4a5568;
        }
        
        .choice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .choice-number {
            font-weight: 600;
            color: #667eea;
            font-size: 16px;
        }
        
        .choice-time {
            font-size: 12px;
            color: #718096;
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .choice-content p {
            margin: 6px 0;
            color: #4a5568;
        }
        
        .selected-model-highlight {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .imported-result-note {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .imported-result-note p {
            color: #742a2a;
            margin: 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIæ¨¡å‹ç›²æµ‹å¹³å°</h1>
            <p>å®¢è§‚è¯„ä¼°ä¸åŒAIæ¨¡å‹çš„è¾“å‡ºè´¨é‡ï¼Œé€‰æ‹©æ‚¨è®¤ä¸ºæœ€å¥½çš„ç»“æœ</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <h2>ğŸ“ å¯¼å…¥æµ‹è¯•æ•°æ®</h2>
            
            <!-- åŠŸèƒ½é€‰æ‹© -->
            <div class="function-selector">
                <div class="function-tabs">
                    <button class="function-tab active" id="newTestTab" onclick="switchFunction('newTest')">ğŸ†• æ–°å»ºæµ‹è¯•</button>
                    <button class="function-tab" id="importResultsTab" onclick="switchFunction('importResults')">ğŸ“Š å¯¼å…¥ç»“æœ</button>
                </div>
            </div>
            
            <!-- æ–°å»ºæµ‹è¯•åŒºåŸŸ -->
            <div class="function-content" id="newTestContent">
                <div class="file-input-group">
                    <label>è¾“å…¥æ–‡ä»¶ (JSONæ ¼å¼) - ä»…é™ä¸€ä¸ªæ–‡ä»¶</label>
                    <input type="file" id="inputFile" class="file-input" accept=".json">
                    <label for="inputFile" class="file-label">ğŸ“„ é€‰æ‹©è¾“å…¥æ–‡ä»¶</label>
                    <div class="file-list" id="inputFileList">
                        <div style="padding: 20px; text-align: center; color: #718096;">
                            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©è¾“å…¥æ–‡ä»¶ï¼ˆä»…é™ä¸€ä¸ªï¼‰
                        </div>
                    </div>
                </div>

                <div class="file-input-group">
                    <label>è¾“å‡ºç»“æœæ–‡ä»¶ (JSONæ ¼å¼) - ä¸æ”¯æŒåŒåæ–‡ä»¶</label>
                    <input type="file" id="outputFileInput" class="file-input" accept=".json" multiple>
                    <label for="outputFileInput" class="file-label">ğŸ“„ é€‰æ‹©è¾“å‡ºæ–‡ä»¶</label>
                    <div class="file-list" id="outputFileList">
                        <div style="padding: 20px; text-align: center; color: #718096;">
                            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ è¾“å‡ºæ–‡ä»¶ï¼ˆä¸æ”¯æŒåŒåæ–‡ä»¶ï¼‰
                        </div>
                    </div>
                </div>

                <div class="cache-controls">
                    <button class="cache-btn" id="clearCacheBtn" onclick="clearAllCache()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç¼“å­˜</button>
                    <div class="cache-info" id="cacheInfo"></div>
                </div>

                <button class="start-btn" id="startBtn" disabled>ğŸš€ å¼€å§‹æµ‹è¯•</button>
            </div>

            <!-- å¯¼å…¥ç»“æœåŒºåŸŸ -->
            <div class="function-content" id="importResultsContent" style="display: none;">
                <div class="file-input-group">
                    <label>æµ‹è¯•ç»“æœæ–‡ä»¶ (JSONæ ¼å¼)</label>
                    <input type="file" id="resultsFile" class="file-input" accept=".json">
                    <label for="resultsFile" class="file-label">ğŸ“„ é€‰æ‹©ç»“æœæ–‡ä»¶</label>
                    <div class="file-info" id="resultsFileInfo"></div>
                </div>

                <button class="start-btn" id="importResultsBtn" disabled>ğŸ“Š æŸ¥çœ‹ç»“æœ</button>
            </div>
        </div>

        <div class="test-section" id="testSection">
            <div class="test-header">
                <h2>ğŸ§ª ç›²æµ‹è¿›è¡Œä¸­</h2>
                <div class="test-controls">
                    <button class="nav-btn home-btn" onclick="goHome()">ğŸ  å›åˆ°å¼€å§‹</button>
                    <button class="nav-btn results-btn" onclick="showResults()">ğŸ“Š æŸ¥çœ‹ç»“æœ</button>
                    <div class="progress-info" id="progressInfo">ç¬¬ 1 é¢˜ / å…± 0 é¢˜</div>
                </div>
            </div>

            <div class="test-content">
                <div class="input-section">
                    <h3>ğŸ“ è¾“å…¥å†…å®¹</h3>
                    <div class="test-info" id="testInfo">
                        <div class="info-item">
                            <span class="info-label">æµ‹è¯•ID:</span>
                            <span class="info-value" id="currentTestId">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ç»„åˆID:</span>
                            <span class="info-value" id="currentCombinationId">-</span>
                        </div>
                    </div>
                    <div class="input-text" id="inputText"></div>
                    <div class="input-images" id="inputImages"></div>
                </div>

                <div class="output-section">
                    <h3>ğŸ¨ è¯·é€‰æ‹©æ‚¨è®¤ä¸ºæœ€å¥½çš„è¾“å‡ºç»“æœ</h3>
                    <div class="keyboard-hint">ğŸ’¡ æç¤ºï¼šâ† â†’ é€‰æ‹©ç­”æ¡ˆ | â†‘ â†“ å¿«é€Ÿå¯¼èˆª | Enterç¡®è®¤å¹¶è¿›å…¥ä¸‹ä¸€é¢˜</div>
                    <div class="output-grid" id="outputGrid"></div>
                </div>

                <div class="navigation-buttons">
                    <button class="nav-btn prev-btn" id="prevBtn">â¬…ï¸ ä¸Šä¸€é¢˜</button>
                    <div class="preference-reason-section">
                        <label class="preference-reason-label" for="preferenceReason">ğŸ’­ åå¥½åŸå› ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea
                            id="preferenceReason"
                            class="preference-reason-textarea"
                            placeholder="è¯·æè¿°æ‚¨é€‰æ‹©è¯¥ç»“æœçš„åŸå› ï¼Œä¾‹å¦‚ï¼šå›¾ç‰‡è´¨é‡æ›´å¥½ã€åˆ›æ„æ›´ä¸°å¯Œã€æ›´ç¬¦åˆè¦æ±‚ç­‰..."
                            onchange="savePreferenceReason()"
                        ></textarea>
                    </div>
                    <button class="nav-btn next-btn" id="nextBtn">ä¸‹ä¸€é¢˜ â¡ï¸</button>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <h2>ğŸ“Š æµ‹è¯•ç»“æœç»Ÿè®¡</h2>

            <!-- å¯¼èˆªæŒ‰é’® -->
            <div class="results-nav">
                <button class="nav-btn home-btn" onclick="goHome()">ğŸ  å›åˆ°å¼€å§‹</button>
            </div>

            <!-- è¿›åº¦æ¦‚è§ˆ -->
            <div class="progress-overview" id="progressOverview">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
            </div>

            <!-- æ¨¡å‹å¯¹æ¯”å›¾è¡¨ -->
            <div class="model-comparison" id="modelComparison">
                <h3>ğŸ† æ¨¡å‹è¡¨ç°å¯¹æ¯”</h3>
                <div class="chart-container" id="chartContainer"></div>
            </div>

            <!-- ELOè¯„åˆ†æ’å -->
            <div class="elo-ranking" id="eloRanking">
                <h3>ğŸ“ˆ ELOè¯„åˆ†æ’å</h3>
                <div class="elo-container" id="eloContainer"></div>
            </div>

            <!-- è¯¦ç»†ç»Ÿè®¡ -->
            <div class="summary-stats" id="summaryStats"></div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="results-actions">
                <button class="action-btn" id="viewDetailsBtn" onclick="showDetailedResults()">ğŸ“‹ æŸ¥çœ‹è¯¦ç»†ç»“æœ</button>
                <button class="action-btn" id="continueTestBtn" onclick="continueTest()">ğŸ”„ ç»§ç»­æµ‹è¯•</button>
                <button class="export-btn" id="exportBtn">ğŸ’¾ å¯¼å‡ºç»“æœ</button>
            </div>
        </div>

        <!-- åª’ä½“æ¨¡æ€æ¡† -->
        <div class="media-modal" id="mediaModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">åª’ä½“é¢„è§ˆ</h3>
                    <button class="close-btn" onclick="closeMediaModal()">Ã—</button>
                </div>
                <div class="modal-body">
                    <div id="modalMedia"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let testData = {
            inputData: {},
            outputData: [],
            currentIndex: 0,
            userPreferences: {},
            preferenceReasons: {},
            totalQuestions: 0
        };
        let outputModels = [];
        let uploadedFiles = [];
        let currentTestKey = null; // å½“å‰æµ‹è¯•çš„å”¯ä¸€æ ‡è¯†
        let inputFileItem = null; // æ–°å¢ï¼šè¾“å…¥æ–‡ä»¶é¡¹

        const uploadSection = document.getElementById('uploadSection');
        const testSection = document.getElementById('testSection');
        const resultsSection = document.getElementById('resultsSection');
        const startBtn = document.getElementById('startBtn');
        const inputFile = document.getElementById('inputFile');
        const outputFileInput = document.getElementById('outputFileInput');
        const outputFileList = document.getElementById('outputFileList');
        const importResultsBtn = document.getElementById('importResultsBtn');
        const resultsFile = document.getElementById('resultsFile');

        inputFile.addEventListener('change', handleInputFileChange);
        outputFileInput.addEventListener('change', handleOutputFileAdd);
        startBtn.addEventListener('click', startTest);
        resultsFile.addEventListener('change', handleResultsFileChange);
        importResultsBtn.addEventListener('click', importResults);

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('keydown', handleKeyDown);

        // åŠŸèƒ½åˆ‡æ¢å‡½æ•°
        function switchFunction(functionType) {
            const newTestTab = document.getElementById('newTestTab');
            const importResultsTab = document.getElementById('importResultsTab');
            const newTestContent = document.getElementById('newTestContent');
            const importResultsContent = document.getElementById('importResultsContent');

            if (functionType === 'newTest') {
                newTestTab.classList.add('active');
                importResultsTab.classList.remove('active');
                newTestContent.style.display = 'block';
                importResultsContent.style.display = 'none';
            } else if (functionType === 'importResults') {
                importResultsTab.classList.add('active');
                newTestTab.classList.remove('active');
                importResultsContent.style.display = 'block';
                newTestContent.style.display = 'none';
            }
        }

        // å¤„ç†ç»“æœæ–‡ä»¶é€‰æ‹©
        function handleResultsFileChange(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('resultsFileInfo').textContent =
                    `å·²é€‰æ‹©: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                importResultsBtn.disabled = false;
            }
        }

        // å¯¼å…¥ç»“æœå‡½æ•°
        async function importResults() {
            try {
                const file = resultsFile.files[0];
                if (!file) {
                    alert('è¯·é€‰æ‹©ç»“æœæ–‡ä»¶');
                    return;
                }

                const resultData = await readFileAsJSON(file);

                // éªŒè¯ç»“æœæ–‡ä»¶æ ¼å¼ - é€‚é…å®é™…çš„ç»“æœæ–‡ä»¶ç»“æ„
                if (!resultData.userPreferences) {
                    throw new Error('ç»“æœæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘userPreferenceså­—æ®µ');
                }

                // è®¾ç½®æµ‹è¯•æ•°æ® - é€‚é…å®é™…çš„ç»“æœæ–‡ä»¶ç»“æ„
                testData = {
                    inputData: resultData.inputInfo || {}, // ä½¿ç”¨inputInfoè€Œä¸æ˜¯inputData
                    outputData: [], // ç»“æœæ–‡ä»¶ä¸­æ²¡æœ‰outputDataï¼Œéœ€è¦ä»userPreferencesé‡å»º
                    currentIndex: 0,
                    userPreferences: resultData.userPreferences,
                    totalQuestions: resultData.testInfo?.totalQuestions || 0,
                    isImportedResult: true // æ ‡è®°è¿™æ˜¯å¯¼å…¥çš„ç»“æœ
                };

                // ä»userPreferencesé‡å»ºoutputDataå’ŒoutputModels
                const modelNames = new Set();
                Object.values(resultData.userPreferences).forEach(pref => {
                    if (pref.model1Name) modelNames.add(pref.model1Name);
                    if (pref.model2Name) modelNames.add(pref.model2Name);
                });

                outputModels = Array.from(modelNames);

                // ç›´æ¥æ˜¾ç¤ºç»“æœé¡µé¢
                uploadSection.style.display = 'none';
                testSection.style.display = 'none';
                resultsSection.style.display = 'block';

                // æ˜¾ç¤ºæ ‡é¢˜åŒºåŸŸ
                document.querySelector('.header').style.display = 'block';

                // æ˜¾ç¤ºç»“æœ
                displayResults();

            } catch (error) {
                alert('å¯¼å…¥ç»“æœå¤±è´¥: ' + error.message);
            }
        }

        function handleInputFileChange(event) {
            const file = event.target.files[0];
            if (file) {
                // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰è¾“å…¥æ–‡ä»¶
                if (inputFileItem) {
                    alert('åªèƒ½å¯¼å…¥ä¸€ä¸ªè¾“å…¥æ–‡ä»¶ã€‚è¯·å…ˆåˆ é™¤å½“å‰è¾“å…¥æ–‡ä»¶ã€‚');
                    event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    return;
                }

                inputFileItem = {
                    file: file,
                    name: file.name,
                    size: file.size,
                    status: 'loading',
                    data: null
                };
                updateInputFileList();
                loadInputFileData(inputFileItem);
            }
        }

        function loadInputFileData(fileItem) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    fileItem.data = data;
                    fileItem.status = 'success';
                    updateInputFileList();
                    checkStartButton();
                } catch (error) {
                    fileItem.status = 'error';
                    updateInputFileList();
                    alert('è¾“å…¥æ–‡ä»¶è§£æå¤±è´¥: ' + fileItem.name + ' - ' + error.message);
                }
            };
            reader.onerror = () => {
                fileItem.status = 'error';
                updateInputFileList();
                alert('è¾“å…¥æ–‡ä»¶è¯»å–å¤±è´¥: ' + fileItem.name);
            };
            reader.readAsText(fileItem.file);
        }

        function updateInputFileList() {
            const inputFileList = document.getElementById('inputFileList');
            if (!inputFileItem) {
                inputFileList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #718096;">
                        ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©è¾“å…¥æ–‡ä»¶ï¼ˆä»…é™ä¸€ä¸ªï¼‰
                    </div>
                `;
                return;
            }

            inputFileList.innerHTML = `
                <div class="file-item">
                    <div class="file-info">
                        <span class="file-name">${inputFileItem.name}</span>
                        <span class="file-size">(${(inputFileItem.size / 1024).toFixed(1)} KB)</span>
                        <span class="file-status ${inputFileItem.status}">
                            ${inputFileItem.status === 'loading' ? 'åŠ è½½ä¸­...' :
                              inputFileItem.status === 'success' ? 'âœ“ å·²åŠ è½½' : 'âœ— é”™è¯¯'}
                        </span>
                    </div>
                    <button class="delete-btn" onclick="removeInputFile()">åˆ é™¤</button>
                </div>
            `;
        }

        function removeInputFile() {
            inputFileItem = null;
            document.getElementById('inputFile').value = '';
            updateInputFileList();
            checkStartButton();
        }

        function handleOutputFileAdd(event) {
            const files = event.target.files;
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    addOutputFile(files[i]);
                }
            }
        }

        function addOutputFile(file) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶
            const existingFile = uploadedFiles.find(f => f.name === file.name);
            if (existingFile) {
                alert(`æ–‡ä»¶ "${file.name}" å·²å­˜åœ¨ï¼Œä¸èƒ½é‡å¤å¯¼å…¥åŒåæ–‡ä»¶ã€‚`);
                return;
            }

            const fileItem = {
                file: file,
                name: file.name,
                size: file.size,
                status: 'loading',
                data: null
            };

            uploadedFiles.push(fileItem);
            updateFileList();
            loadFileData(fileItem);
        }

        function loadFileData(fileItem) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    fileItem.data = data;
                    fileItem.status = 'success';
                    updateFileList();
                    checkStartButton();
                } catch (error) {
                    fileItem.status = 'error';
                    updateFileList();
                    alert('æ–‡ä»¶è§£æå¤±è´¥: ' + fileItem.name + ' - ' + error.message);
                }
            };
            reader.onerror = () => {
                fileItem.status = 'error';
                updateFileList();
                alert('æ–‡ä»¶è¯»å–å¤±è´¥: ' + fileItem.name);
            };
            reader.readAsText(fileItem.file);
        }

        function removeOutputFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
            checkStartButton();
        }

        function updateFileList() {
            if (uploadedFiles.length === 0) {
                outputFileList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #718096;">
                        ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ è¾“å‡ºæ–‡ä»¶ï¼ˆä¸æ”¯æŒåŒåæ–‡ä»¶ï¼‰
                    </div>
                `;
                return;
            }

            outputFileList.innerHTML = uploadedFiles.map((fileItem, index) => `
                <div class="file-item">
                    <div class="file-info">
                        <span class="file-name">${fileItem.name}</span>
                        <span class="file-size">(${(fileItem.size / 1024).toFixed(1)} KB)</span>
                        <span class="file-status ${fileItem.status}">
                            ${fileItem.status === 'loading' ? 'åŠ è½½ä¸­...' : 
                              fileItem.status === 'success' ? 'âœ“ å·²åŠ è½½' : 'âœ— é”™è¯¯'}
                        </span>
                    </div>
                    <button class="delete-btn" onclick="removeOutputFile(${index})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        function checkStartButton() {
            const hasInput = inputFileItem && inputFileItem.status === 'success';
            const hasValidOutputs = uploadedFiles.filter(f => f.status === 'success').length >= 2;
            startBtn.disabled = !(hasInput && hasValidOutputs);
        }

        function validateData(inputData, outputData) {
            if (!inputData || typeof inputData !== 'object') {
                throw new Error('è¾“å…¥æ•°æ®æ ¼å¼é”™è¯¯');
            }
            if (!outputData || outputData.length < 2) {
                throw new Error('è‡³å°‘éœ€è¦2ä¸ªè¾“å‡ºæ–‡ä»¶è¿›è¡Œå¯¹æ¯”');
            }
            
            const inputKeys = Object.keys(inputData).filter(key => key !== 'test_info');
            const validTestIds = new Set();
            
            // æ£€æŸ¥æ¯ä¸ªè¾“å‡ºæ–‡ä»¶çš„æ•°æ®ç»“æ„ï¼Œæ”¶é›†æ‰€æœ‰æœ‰æ•ˆçš„test_id
            for (let output of outputData) {
                const outputKeys = Object.keys(output.data).filter(key => key !== 'test_info');
                
                // æ£€æŸ¥æ¯ä¸ªtest_idçš„æœ‰æ•ˆæ€§
                for (let testId of outputKeys) {
                    const resultItem = output.data[testId];
                    if (isValidOutput(resultItem)) {
                        // æ£€æŸ¥è¾“å…¥æ–‡ä»¶ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„test_id
                        if (inputData[testId]) {
                            validTestIds.add(testId);
                        } else {
                            console.warn(`è¾“å‡ºæ–‡ä»¶ ${output.name} ä¸­çš„ test_id ${testId} åœ¨è¾“å…¥æ–‡ä»¶ä¸­ä¸å­˜åœ¨`);
                        }
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æœ‰æ•ˆtest_id
            if (validTestIds.size === 0) {
                throw new Error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æµ‹è¯•ç”¨ä¾‹ï¼ˆè¾“å‡ºæœ‰æ•ˆä¸”è¾“å…¥å­˜åœ¨ï¼‰');
            }
            
            console.log(`æ‰¾åˆ° ${validTestIds.size} ä¸ªæœ‰æ•ˆæµ‹è¯•ç”¨ä¾‹:`, Array.from(validTestIds));
            console.log(`è¾“å…¥æ–‡ä»¶åŒ…å« ${inputKeys.length} ä¸ªtest_id:`, inputKeys);
            return Array.from(validTestIds);
        }

        function isValidOutput(outputItem) {
            if (!outputItem || !outputItem.output_display_info) {
                return false;
            }
            
            // æ£€æŸ¥output_display_infoç»“æ„
            const displayInfo = outputItem.output_display_info;
            if (!displayInfo.output_images && !displayInfo.output_videos) {
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„åª’ä½“å†…å®¹
            const hasImages = displayInfo.output_images && Array.isArray(displayInfo.output_images) && displayInfo.output_images.length > 0;
            const hasVideos = displayInfo.output_videos && Array.isArray(displayInfo.output_videos) && displayInfo.output_videos.length > 0;
            
            // å¦‚æœoutput_imageså’Œoutput_videoséƒ½ä¸ºç©ºï¼Œåˆ™è®¤ä¸ºæ˜¯æ— æ•ˆè¾“å‡º
            return hasImages || hasVideos;
        }

        function generateTestCombinations(outputData, validTestIds) {
            const combinations = [];
            const modelCount = outputData.length;
            
            // ç”ŸæˆC(n,2)ç»„åˆ
            for (let i = 0; i < modelCount; i++) {
                for (let j = i + 1; j < modelCount; j++) {
                    const model1 = outputData[i];
                    const model2 = outputData[j];
                    
                    // ä¸ºæ¯ä¸ªæœ‰æ•ˆçš„test_idåˆ›å»ºå¯¹æ¯”ç»„åˆ
                    for (let testId of validTestIds) {
                        // æ£€æŸ¥ä¸¤ä¸ªæ¨¡å‹åœ¨è¿™ä¸ªtest_idä¸Šéƒ½æœ‰æœ‰æ•ˆè¾“å‡º
                        if (isValidOutput(model1.data[testId]) && isValidOutput(model2.data[testId])) {
                            combinations.push({
                                testId: testId,
                                model1: {
                                    name: model1.name,
                                    index: i,
                                    data: model1.data[testId]
                                },
                                model2: {
                                    name: model2.name,
                                    index: j,
                                    data: model2.data[testId]
                                }
                            });
                        }
                    }
                }
            }
            
            return combinations;
        }

        async function startTest() {
            try {
                // æ¸…ç†é¢„åŠ è½½ç¼“å­˜
                preloadManager.clearCache();
                
                if (!inputFileItem || inputFileItem.status !== 'success') {
                    throw new Error('è¯·å…ˆé€‰æ‹©å¹¶åŠ è½½æœ‰æ•ˆçš„è¾“å…¥æ–‡ä»¶');
                }
                
                const inputFileData = inputFileItem.data;
                const validOutputFiles = uploadedFiles.filter(f => f.status === 'success');
                
                if (validOutputFiles.length < 2) {
                    throw new Error('è‡³å°‘éœ€è¦2ä¸ªæœ‰æ•ˆçš„è¾“å‡ºæ–‡ä»¶è¿›è¡Œå¯¹æ¯”');
                }

                const outputData = validOutputFiles.map(fileItem => {
                    // ä»test_info.test_versionè·å–ç‰ˆæœ¬ä¿¡æ¯ä½œä¸ºæ¨¡å‹åç§°
                    let modelName = "Unknown Model";
                    if (fileItem.data.test_info && fileItem.data.test_info.test_version) {
                        modelName = fileItem.data.test_info.test_version;
                    } else {
                        // å¤‡ç”¨æ–¹æ¡ˆï¼šä»æ–‡ä»¶åæå–
                        modelName = fileItem.name.replace('.json', '').replace('output_', '').replace('_', ' ');
                    }
                    return { name: modelName, data: fileItem.data };
                });

                outputModels = outputData.map(item => item.name);

                // éªŒè¯æ•°æ®å¹¶è·å–æœ‰æ•ˆçš„test_id
                const validTestIds = validateData(inputFileData, outputData);
                
                // ç”Ÿæˆæµ‹è¯•ç»„åˆ
                const testCombinations = generateTestCombinations(outputData, validTestIds);
                
                if (testCombinations.length === 0) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æµ‹è¯•ç»„åˆ');
                }

                console.log(`ç”Ÿæˆäº† ${testCombinations.length} ä¸ªæµ‹è¯•ç»„åˆ`);
                console.log('æµ‹è¯•ç»„åˆè¯¦æƒ…:', testCombinations);

                // ç”Ÿæˆæµ‹è¯•å”¯ä¸€æ ‡è¯†
                currentTestKey = generateTestKey(inputFileData, outputData);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å¯æ¢å¤çš„æµ‹è¯•
                let shouldResume = false;
                const resumeResult = checkForResumableTest(inputFileData, outputData);
                
                // å¦‚æœcheckForResumableTestè¿”å›ç‰¹æ®Šå€¼ï¼Œè¯´æ˜å·²ç»å¤„ç†äº†å·²å®Œæˆæµ‹è¯•çš„æƒ…å†µ
                // æ­¤æ—¶åº”è¯¥ç›´æ¥è¿”å›ï¼Œä¸ç»§ç»­æ‰§è¡ŒstartTestæµç¨‹
                if (resumeResult === 'completed') {
                    return; // ç›´æ¥è¿”å›ï¼Œä¸ç»§ç»­æ‰§è¡Œ
                }
                
                // checkForResumableTestå‡½æ•°å·²ç»å¤„ç†äº†æ‰€æœ‰æƒ…å†µï¼ŒåŒ…æ‹¬å·²å®Œæˆæµ‹è¯•çš„ç›´æ¥è·³è½¬
                // å¦‚æœè¿”å›trueï¼Œè¯´æ˜ç”¨æˆ·é€‰æ‹©ç»§ç»­æœªå®Œæˆçš„æµ‹è¯•
                // å¦‚æœè¿”å›falseï¼Œè¯´æ˜æ²¡æœ‰ç¼“å­˜æˆ–ç”¨æˆ·é€‰æ‹©é‡æ–°å¼€å§‹
                shouldResume = resumeResult === true;

                testData.inputData = inputFileData;
                testData.outputData = outputData;
                testData.testCombinations = testCombinations;
                testData.totalQuestions = testCombinations.length;
                testData.isImportedResult = false; // é‡ç½®å¯¼å…¥ç»“æœæ ‡è®°

                if (shouldResume) {
                    // æ¢å¤ä¹‹å‰çš„è¿›åº¦
                    loadTestProgress(currentTestKey);
                } else {
                    // å¼€å§‹æ–°çš„æµ‹è¯•
                    testData.currentIndex = 0;
                    testData.userPreferences = {};
                }

                showTestSection();
                loadCurrentQuestion();
                updateCacheInfo();
                
                // åœ¨æµ‹è¯•å¼€å§‹æ—¶å°±å¼€å§‹é¢„åŠ è½½ç¼©ç•¥å›¾
                setTimeout(() => {
                    smartPreloadThumbnails(0);
                }, 500); // å»¶è¿Ÿ500msï¼Œç¡®ä¿ç¬¬ä¸€é¡µå®Œå…¨åŠ è½½åå†å¼€å§‹é¢„åŠ è½½

            } catch (error) {
                alert('å¯åŠ¨æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        function readFileAsJSON(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        resolve(data);
                    } catch (error) {
                        reject(new Error('JSONè§£æå¤±è´¥: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsText(file);
            });
        }

        function showTestSection() {
            uploadSection.style.display = 'none';
            testSection.style.display = 'block';
            resultsSection.style.display = 'none';
            
            // éšè—æ ‡é¢˜åŒºåŸŸä»¥èŠ‚çœç©ºé—´
            document.querySelector('.header').style.display = 'none';
        }

        function loadCurrentQuestion() {
            const currentCombination = testData.testCombinations[testData.currentIndex];
            const inputItem = testData.inputData[currentCombination.testId];

            document.getElementById('progressInfo').textContent = 
                `ç¬¬ ${testData.currentIndex + 1} é¢˜ / å…± ${testData.totalQuestions} é¢˜`;

            // æ˜¾ç¤ºæµ‹è¯•ä¿¡æ¯
            document.getElementById('currentTestId').textContent = currentCombination.testId;
            document.getElementById('currentCombinationId').textContent = 
                `${currentCombination.model1.index}-${currentCombination.model2.index}`;

            displayInput(inputItem);
            displayOutputs(currentCombination);
            updateNavigationButtons();
            loadPreferenceReason();

            // æ˜¾ç¤ºä¹‹å‰çš„é€‰æ‹©çŠ¶æ€
            const combinationKey = `${currentCombination.testId}_${currentCombination.model1.index}_${currentCombination.model2.index}`;
            if (testData.userPreferences[combinationKey]) {
                const selectedModelIndex = testData.userPreferences[combinationKey].selectedModelIndex;
                const outputItems = document.querySelectorAll('.output-item');
                outputItems.forEach((item, index) => {
                    if (parseInt(item.dataset.modelIndex) === selectedModelIndex) {
                        item.classList.add('selected');
                    }
                });
            }
            
            // ç«‹å³å¼€å§‹é¢„åŠ è½½ä¸‹ä¸€é¡µçš„ç¼©ç•¥å›¾
            if (testData.currentIndex < testData.totalQuestions - 1) {
                // ä½¿ç”¨æ™ºèƒ½é¢„åŠ è½½ï¼Œé¢„åŠ è½½å¤šé¡µç¼©ç•¥å›¾
                if (window.requestIdleCallback) {
                    requestIdleCallback(() => {
                        smartPreloadThumbnails(testData.currentIndex);
                    });
                } else {
                    setTimeout(() => {
                        smartPreloadThumbnails(testData.currentIndex);
                    }, 100); // çŸ­æš‚å»¶è¿Ÿï¼Œç¡®ä¿å½“å‰é¡µé¢ä¼˜å…ˆæ¸²æŸ“
                }
            }
        }

        function displayInput(inputItem) {
            const inputText = document.getElementById('inputText');
            const inputImages = document.getElementById('inputImages');

            const texts = inputItem.input_display_info?.input_texts || [];
            inputText.textContent = texts.join(' ');

            const images = inputItem.input_display_info?.input_images || [];
            inputImages.innerHTML = '';
            
            images.forEach((imageUrl, index) => {
                // ä¸ºOSSå›¾ç‰‡ç”Ÿæˆç¼©ç•¥å›¾URL
                const thumbnailUrl = `${imageUrl}?x-oss-process=image/format,webp,image/resize,w_512,h_512`;
                const img = document.createElement('img');
                img.src = thumbnailUrl;
                img.className = 'input-image';
                img.onclick = () => showMediaModal(imageUrl, 'image', `è¾“å…¥å›¾ç‰‡ ${index + 1}`);
                inputImages.appendChild(img);
            });
        }

        function displayOutputs(combination) {
            const outputGrid = document.getElementById('outputGrid');
            outputGrid.innerHTML = '';

            const outputs = [];
            
            // å¤„ç†model1çš„è¾“å‡º
            const model1Outputs = extractDisplayInfo(combination.model1.data);
            if (model1Outputs.length > 0) {
                outputs.push({
                    modelName: combination.model1.name,
                    mediaItems: model1Outputs,
                    modelIndex: combination.model1.index
                });
            }
            
            // å¤„ç†model2çš„è¾“å‡º
            const model2Outputs = extractDisplayInfo(combination.model2.data);
            if (model2Outputs.length > 0) {
                outputs.push({
                    modelName: combination.model2.name,
                    mediaItems: model2Outputs,
                    modelIndex: combination.model2.index
                });
            }

            // éšæœºæ‰“ä¹±è¾“å‡ºé¡ºåº
            const shuffledOutputs = shuffleArray(outputs);

            // æ ¹æ®è¾“å‡ºæ•°é‡åŠ¨æ€è®¾ç½®ç½‘æ ¼å¸ƒå±€
            const totalItems = shuffledOutputs.length;
            
            if (totalItems === 1) {
                // ä¸ºå•ä¸ªç»“æœæ·»åŠ ç‰¹æ®Šæ ·å¼
                outputGrid.classList.add('single-item');
            } else {
                outputGrid.classList.remove('single-item');
            }
            
            // ä¿æŒå·¦å³pairå¯¹çš„å±•ç¤ºæ–¹å¼
            outputGrid.style.gridTemplateColumns = '1fr 1fr';

            shuffledOutputs.forEach((output, index) => {
                const outputItem = document.createElement('div');
                outputItem.className = 'output-item';
                outputItem.dataset.modelIndex = output.modelIndex;
                outputItem.dataset.outputIndex = index;

                // åˆ›å»ºåª’ä½“å±•ç¤ºåŒºåŸŸ
                let mediaElements = '';
                output.mediaItems.forEach((mediaItem, mediaIndex) => {
                    if (mediaItem.type === 'video') {
                        mediaElements += `
                            <div class="media-container" onclick="showMediaModal('${mediaItem.url}', 'video', 'è¾“å‡º ${mediaIndex + 1}')">
                                <video src="${mediaItem.url}" alt="è¾“å‡ºç»“æœ ${mediaIndex + 1}" class="output-image" preload="metadata">
                                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                                </video>
                                <div class="media-overlay">
                                    <span class="zoom-icon">â–¶ï¸</span>
                                </div>
                            </div>
                        `;
                    } else {
                        // ä¸ºå›¾ç‰‡æ·»åŠ ç¼©ç•¥å›¾åŠŸèƒ½
                        const uniqueId = `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        // ä¸ºOSSå›¾ç‰‡ç”Ÿæˆç¼©ç•¥å›¾URL
                        const thumbnailUrl = `${mediaItem.url}?x-oss-process=image/format,webp,image/resize,w_512,h_512`;
                        mediaElements += `
                            <div class="media-container" onclick="showMediaModal('${mediaItem.url}', 'image', 'è¾“å‡º ${mediaIndex + 1}')">
                                <div class="thumbnail-container">
                                    <img src="${thumbnailUrl}" 
                                         alt="è¾“å‡ºç»“æœ ${mediaIndex + 1}" 
                                         class="thumbnail-image" 
                                         id="thumbnail_${uniqueId}"
                                         onload="onThumbnailLoad('${uniqueId}')"
                                         onerror="onThumbnailError('${uniqueId}')">
                                </div>
                                <div class="media-overlay">
                                    <span class="zoom-icon">ğŸ”</span>
                                </div>
                            </div>
                        `;
                    }
                });

                // æ·»åŠ åª’ä½“å®¹å™¨åŒ…è£…ï¼Œæ”¯æŒæ»šåŠ¨
                outputItem.innerHTML = `
                    <div class="media-scroll-container">
                        ${mediaElements}
                    </div>
                    <div class="output-info">é€‰é¡¹ ${index + 1}</div>
                `;

                outputItem.onclick = (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯åª’ä½“å®¹å™¨ï¼Œä¸è§¦å‘é€‰æ‹©
                    if (e.target.closest('.media-container')) {
                        return;
                    }
                    selectOutput(outputItem, output.modelIndex);
                };
                outputGrid.appendChild(outputItem);
            });
        }

        function extractDisplayInfo(outputItem) {
            const mediaItems = [];
            
            if (!outputItem || !outputItem.output_display_info) {
                return mediaItems;
            }
            
            const displayInfo = outputItem.output_display_info;
            
            // æŒ‰é¡ºåºæ·»åŠ å›¾ç‰‡
            if (displayInfo.output_images && Array.isArray(displayInfo.output_images)) {
                displayInfo.output_images.forEach(imageUrl => {
                    if (imageUrl) {
                        mediaItems.push({
                            url: imageUrl,
                            type: 'image'
                        });
                    }
                });
            }
            
            // æŒ‰é¡ºåºæ·»åŠ è§†é¢‘
            if (displayInfo.output_videos && Array.isArray(displayInfo.output_videos)) {
                displayInfo.output_videos.forEach(videoUrl => {
                    if (videoUrl) {
                        mediaItems.push({
                            url: videoUrl,
                            type: 'video'
                        });
                    }
                });
            }
            
            return mediaItems;
        }

        // é¢„åŠ è½½ç¼©ç•¥å›¾å‡½æ•°
        function preloadThumbnails(combination) {
            const outputs = [];
            
            // æ”¶é›†æ‰€æœ‰å›¾ç‰‡URL
            const model1Outputs = extractDisplayInfo(combination.model1.data);
            const model2Outputs = extractDisplayInfo(combination.model2.data);
            
            [...model1Outputs, ...model2Outputs].forEach(mediaItem => {
                if (mediaItem.type === 'image') {
                    // åªé¢„åŠ è½½ç¼©ç•¥å›¾ï¼Œä¸é¢„åŠ è½½åŸå›¾
                    const thumbnailUrl = `${mediaItem.url}?x-oss-process=image/format,webp,image/resize,w_512,h_512`;
                    if (!preloadManager.isPreloaded(thumbnailUrl)) {
                        const thumbnailImg = new Image();
                        thumbnailImg.src = thumbnailUrl;
                        preloadManager.addPreloadedImage(thumbnailUrl, thumbnailImg);
                        outputs.push(thumbnailImg);
                    }
                }
            });
            
            return outputs;
        }

        // é¢„åŠ è½½ç®¡ç†å™¨
        const preloadManager = {
            preloadedImages: new Map(), // å­˜å‚¨å·²é¢„åŠ è½½çš„å›¾ç‰‡
            maxPreloadCount: 50, // æœ€å¤§é¢„åŠ è½½æ•°é‡ï¼Œæ”¯æŒæ›´å¤šç¼©ç•¥å›¾é¢„åŠ è½½
            
            // æ·»åŠ é¢„åŠ è½½å›¾ç‰‡
            addPreloadedImage(url, image) {
                if (this.preloadedImages.size >= this.maxPreloadCount) {
                    // å¦‚æœè¶…è¿‡æœ€å¤§æ•°é‡ï¼Œåˆ é™¤æœ€æ—©é¢„åŠ è½½çš„å›¾ç‰‡
                    const firstKey = this.preloadedImages.keys().next().value;
                    this.preloadedImages.delete(firstKey);
                }
                this.preloadedImages.set(url, image);
            },
            
            // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²é¢„åŠ è½½
            isPreloaded(url) {
                return this.preloadedImages.has(url);
            },
            
            // è·å–é¢„åŠ è½½çš„å›¾ç‰‡
            getPreloadedImage(url) {
                return this.preloadedImages.get(url);
            },
            
            // æ¸…ç†é¢„åŠ è½½ç¼“å­˜
            clearCache() {
                this.preloadedImages.clear();
            }
        };

        // æ™ºèƒ½é¢„åŠ è½½å‡½æ•° - é¢„åŠ è½½å¤šé¡µç¼©ç•¥å›¾
        function smartPreloadThumbnails(currentIndex) {
            const preloadCount = 5; // é¢„åŠ è½½æ¥ä¸‹æ¥5é¡µçš„ç¼©ç•¥å›¾
            const preloadedPages = new Set();
            
            // æ£€æµ‹ç½‘ç»œçŠ¶å†µï¼Œè°ƒæ•´é¢„åŠ è½½ç­–ç•¥
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            let adjustedPreloadCount = preloadCount;
            
            if (connection) {
                if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                    adjustedPreloadCount = 1; // æ…¢ç½‘ç»œåªé¢„åŠ è½½1é¡µ
                } else if (connection.effectiveType === '3g') {
                    adjustedPreloadCount = 3; // 3Gç½‘ç»œé¢„åŠ è½½3é¡µ
                } else {
                    adjustedPreloadCount = 5; // 4G/5Gç½‘ç»œé¢„åŠ è½½5é¡µ
                }
            }
            
            for (let i = 1; i <= adjustedPreloadCount; i++) {
                const nextIndex = currentIndex + i;
                if (nextIndex < testData.totalQuestions && !preloadedPages.has(nextIndex)) {
                    const nextCombination = testData.testCombinations[nextIndex];
                    preloadThumbnails(nextCombination);
                    preloadedPages.add(nextIndex);
                }
            }
        }

        // ç¼©ç•¥å›¾åŠ è½½å®Œæˆ
        function onThumbnailLoad(uniqueId) {
            const thumbnail = document.getElementById(`thumbnail_${uniqueId}`);
            if (thumbnail) {
                thumbnail.classList.add('loaded');
            }
        }

        // ç¼©ç•¥å›¾åŠ è½½å¤±è´¥
        function onThumbnailError(uniqueId) {
            const thumbnail = document.getElementById(`thumbnail_${uniqueId}`);
            if (thumbnail) {
                thumbnail.style.display = 'none';
            }
        }

        // å®Œæ•´å›¾ç‰‡åŠ è½½å®Œæˆ
        function onFullImageLoad(uniqueId) {
            const fullImage = document.getElementById(`full_${uniqueId}`);
            if (fullImage) {
                fullImage.classList.add('loaded');
            }
        }

        // å®Œæ•´å›¾ç‰‡åŠ è½½å¤±è´¥
        function onFullImageError(uniqueId) {
            const fullImage = document.getElementById(`full_${uniqueId}`);
            if (fullImage) {
                fullImage.style.display = 'none';
            }
        }

        function selectOutput(outputItem, modelIndex) {
            document.querySelectorAll('.output-item').forEach(item => {
                item.classList.remove('selected');
            });
            outputItem.classList.add('selected');

            const currentCombination = testData.testCombinations[testData.currentIndex];
            const combinationKey = `${currentCombination.testId}_${currentCombination.model1.index}_${currentCombination.model2.index}`;
            
            // ä¿ç•™å·²æœ‰çš„åå¥½åŸå› 
            const existingReason = testData.userPreferences[combinationKey]?.preferenceReason || "";
            
            testData.userPreferences[combinationKey] = {
                testId: currentCombination.testId,
                model1Name: currentCombination.model1.name,
                model2Name: currentCombination.model2.name,
                selectedModelIndex: modelIndex,
                selectedModelName: testData.outputData[modelIndex].name,
                preferenceReason: existingReason,
                timestamp: new Date().toISOString()
            };

            // è‡ªåŠ¨ä¿å­˜è¿›åº¦
            saveTestProgress();
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = testData.currentIndex === 0;
            
            if (testData.currentIndex === testData.totalQuestions - 1) {
                nextBtn.textContent = 'å®Œæˆæµ‹è¯• âœ…';
            } else {
                nextBtn.textContent = 'ä¸‹ä¸€é¢˜ â¡ï¸';
            }
        }

        document.getElementById('prevBtn').onclick = () => {
            if (testData.currentIndex > 0) {
                testData.currentIndex--;
                loadCurrentQuestion();
            }
        };

        document.getElementById('nextBtn').onclick = () => {
            const currentCombination = testData.testCombinations[testData.currentIndex];
            const combinationKey = `${currentCombination.testId}_${currentCombination.model1.index}_${currentCombination.model2.index}`;

            if (!testData.userPreferences[combinationKey]) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªè¾“å‡ºç»“æœ');
                return;
            }

            if (testData.currentIndex === testData.totalQuestions - 1) {
                showResults();
            } else {
                testData.currentIndex++;
                loadCurrentQuestion();
            }
        };

        function showResults() {
            // å¦‚æœå½“å‰é¢˜ç›®æœªå®Œæˆï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­
            const currentCombination = testData.testCombinations[testData.currentIndex];
            const combinationKey = `${currentCombination.testId}_${currentCombination.model1.index}_${currentCombination.model2.index}`;
            
            if (!testData.userPreferences[combinationKey]) {
                if (!confirm('å½“å‰é¢˜ç›®å°šæœªå®Œæˆï¼Œæ˜¯å¦ä»è¦æŸ¥çœ‹ç»“æœï¼Ÿ')) {
                    return;
                }
            }
            
            testSection.style.display = 'none';
            resultsSection.style.display = 'block';
            
            // éšè—æ ‡é¢˜åŒºåŸŸä»¥èŠ‚çœç©ºé—´
            document.querySelector('.header').style.display = 'none';
            
            displayResults();
            
            // å¦‚æœæµ‹è¯•å®Œæˆç‡è¾¾åˆ°100%ï¼Œè‡ªåŠ¨å¯¼å‡ºç»“æœ
            const stats = calculateStats();
            if (stats.completionRate === 100) {
                setTimeout(() => {
                    if (confirm('æµ‹è¯•å·²å®Œæˆï¼æ˜¯å¦è‡ªåŠ¨å¯¼å‡ºæµ‹è¯•ç»“æœï¼Ÿ')) {
                        exportResults();
                    }
                }, 1000);
            }
        }

        function displayResults() {
            const stats = calculateStats();
            const modelStats = calculateModelStats();
            
            // æ›´æ–°è¿›åº¦æ¡
            updateProgressBar(stats.completionRate);
            
            // æ›´æ–°è¯¦ç»†ç»Ÿè®¡
            const summaryStats = document.getElementById('summaryStats');
            summaryStats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${stats.totalQuestions}</div>
                    <div class="stat-label">æ€»é¢˜ç›®æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${stats.completedQuestions}</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${stats.completionRate}%</div>
                    <div class="stat-label">å®Œæˆç‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${stats.outputModels}</div>
                    <div class="stat-label">å¯¹æ¯”æ¨¡å‹æ•°</div>
                </div>
            `;
            
            // æ›´æ–°æ¨¡å‹å¯¹æ¯”å›¾è¡¨
            updateModelChart(modelStats);
            
            // æ›´æ–°ELOè¯„åˆ†æ’å
            updateEloRanking();
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateResultButtons(stats.completionRate);
        }

        function updateProgressBar(completionRate) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = `${completionRate}%`;
            progressText.textContent = `${completionRate}%`;
            
            // æ ¹æ®å®Œæˆç‡æ”¹å˜é¢œè‰²
            if (completionRate < 50) {
                progressBar.style.backgroundColor = '#e53e3e';
            } else if (completionRate < 100) {
                progressBar.style.backgroundColor = '#d69e2e';
            } else {
                progressBar.style.backgroundColor = '#48bb78';
            }
        }

        function updateModelChart(modelStats) {
            const chartContainer = document.getElementById('chartContainer');
            
            // åˆ›å»ºç®€å•çš„æŸ±çŠ¶å›¾
            let chartHTML = '<div style="padding: 20px; display: flex; align-items: end; height: 100%; gap: 10px;">';
            
            Object.entries(modelStats).forEach(([modelName, stats]) => {
                const winRate = parseFloat(stats.winRate) || 0;
                const barHeight = (winRate / 100) * 200; // æœ€å¤§é«˜åº¦200px
                
                chartHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                   height: ${barHeight}px; width: 100%; border-radius: 4px 4px 0 0; 
                                   margin-bottom: 10px; position: relative;">
                            <div style="position: absolute; top: -30px; left: 50%; transform: translateX(-50%); 
                                       color: #2d3748; font-weight: bold; font-size: 14px; 
                                       background: white; padding: 2px 6px; border-radius: 4px; 
                                       box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                                ${winRate}%
                            </div>
                        </div>
                        <div style="font-size: 12px; text-align: center; color: #4a5568; 
                                   max-width: 100px; word-wrap: break-word;">${modelName}</div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }

        function updateResultButtons(completionRate) {
            const continueBtn = document.getElementById('continueTestBtn');
            const viewDetailsBtn = document.getElementById('viewDetailsBtn');
            
            // å¦‚æœæ˜¯å¯¼å…¥çš„ç»“æœï¼Œæ˜¾ç¤ºç‰¹æ®Šçš„æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
            if (testData.isImportedResult) {
                viewDetailsBtn.style.display = 'inline-block';
                viewDetailsBtn.textContent = 'ğŸ“‹ æŸ¥çœ‹æµ‹è¯•è¯¦æƒ…';
                viewDetailsBtn.onclick = showImportedResultDetails; // ç»‘å®šå¯¼å…¥ç»“æœè¯¦æƒ…å‡½æ•°
                continueBtn.style.display = 'none'; // å¯¼å…¥ç»“æœæ—¶ä¸æ˜¾ç¤ºç»§ç»­æµ‹è¯•æŒ‰é’®
                return;
            }
            
            // ç»§ç»­æµ‹è¯•æŒ‰é’®å§‹ç»ˆæ˜¾ç¤º
            continueBtn.style.display = 'inline-block';
            
            if (completionRate < 100) {
                continueBtn.textContent = 'ğŸ”„ ç»§ç»­æµ‹è¯•';
            } else {
                continueBtn.textContent = 'ğŸ“‹ æŸ¥çœ‹æµ‹è¯•è¯¦æƒ…';
            }
            
            // æ­£å¸¸æµ‹è¯•æµç¨‹ä¸æ˜¾ç¤º"æŸ¥çœ‹è¯¦ç»†ç»“æœ"æŒ‰é’®
            viewDetailsBtn.style.display = 'none';
        }

        function continueTest() {
            const stats = calculateStats();
            
            if (stats.completionRate < 100) {
                // æœªå®Œæˆæµ‹è¯•ï¼Œç»§ç»­æµ‹è¯•
                resultsSection.style.display = 'none';
                testSection.style.display = 'block';
                loadCurrentQuestion();
            } else {
                // å·²å®Œæˆæµ‹è¯•ï¼Œæ˜¾ç¤ºè¯¦ç»†çš„æµ‹è¯•è¯¦æƒ…é€‰æ‹©ç•Œé¢
                showDetailedTestSelector();
            }
        }

        function showDetailedTestSelector() {
            const stats = calculateStats();
            
            // åˆ›å»ºè¯¦ç»†çš„æµ‹è¯•è¯¦æƒ…é€‰æ‹©ç•Œé¢
            const modalHTML = `
                <div class="test-detail-modal" id="detailedTestModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>ğŸ“‹ æµ‹è¯•è¯¦æƒ…æŸ¥çœ‹</h3>
                            <button class="close-btn" onclick="closeDetailedTestModal()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="test-navigation">
                                <h4>ğŸ“Š æµ‹è¯•æ¦‚è§ˆ</h4>
                                <div class="result-overview">
                                    <p><strong>æ€»é¢˜ç›®æ•°:</strong> ${testData.totalQuestions}</p>
                                    <p><strong>å‚ä¸æ¨¡å‹:</strong> ${outputModels.join(', ')}</p>
                                    <p><strong>å®Œæˆç‡:</strong> ${stats.completionRate}%</p>
                                    <p><strong>å®Œæˆæ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
                                </div>
                                
                                <h4>ğŸ¯ ç”¨æˆ·é€‰æ‹©è¯¦æƒ…ï¼ˆç‚¹å‡»å¯è¿›å…¥æµ‹è¯•ï¼‰</h4>
                                <div class="choice-details">
                                    ${generateDetailedChoiceDetails()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
            if (!document.getElementById('detailedTestModal')) {
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('detailedTestModal').style.display = 'block';
        }

        function generateDetailedChoiceDetails() {
            let detailsHTML = '';
            
            // æŒ‰æ—¶é—´æ’åºç”¨æˆ·é€‰æ‹©
            const sortedPreferences = Object.entries(testData.userPreferences)
                .sort((a, b) => new Date(a[1].timestamp) - new Date(b[1].timestamp));
            
            sortedPreferences.forEach(([key, pref], index) => {
                const testNumber = index + 1;
                const choiceTime = new Date(pref.timestamp).toLocaleString();
                const preferenceReason = pref.preferenceReason || 'æ— ';
                
                // æ‰¾åˆ°å¯¹åº”çš„æµ‹è¯•ç»„åˆç´¢å¼•
                const testIndex = testData.testCombinations.findIndex(combination => {
                    const combinationKey = `${combination.testId}_${combination.model1.index}_${combination.model2.index}`;
                    return combinationKey === key;
                });
                
                detailsHTML += `
                    <div class="choice-item" onclick="navigateToTest(${testIndex})" style="cursor: pointer;">
                        <div class="choice-header">
                            <span class="choice-number">é¢˜ç›® ${testNumber}</span>
                            <span class="choice-time">${choiceTime}</span>
                        </div>
                        <div class="choice-content">
                            <p><strong>æµ‹è¯•ID:</strong> ${pref.testId}</p>
                            <p><strong>å¯¹æ¯”æ¨¡å‹:</strong> ${pref.model1Name} vs ${pref.model2Name}</p>
                            <p><strong>é€‰æ‹©ç»“æœ:</strong> <span class="selected-model-highlight">${pref.selectedModelName}</span></p>
                            <p><strong>é€‰æ‹©åŸå› :</strong> ${preferenceReason}</p>
                        </div>
                    </div>
                `;
            });
            
            return detailsHTML;
        }

        function generateDetailedTestList() {
            let testListHTML = '';
            
            testData.testCombinations.forEach((combination, index) => {
                const combinationKey = `${combination.testId}_${combination.model1.index}_${combination.model2.index}`;
                const hasAnswer = testData.userPreferences[combinationKey];
                const statusClass = hasAnswer ? 'completed' : 'incomplete';
                const statusText = hasAnswer ? 'âœ… å·²å®Œæˆ' : 'â³ æœªå®Œæˆ';
                const selectedModel = hasAnswer ? testData.userPreferences[combinationKey].selectedModelName : 'æœªé€‰æ‹©';
                
                testListHTML += `
                    <div class="test-item ${statusClass}" onclick="navigateToTest(${index})">
                        <div class="test-info">
                            <div class="test-number">é¢˜ç›® ${index + 1}</div>
                            <div class="test-id">ID: ${combination.testId}</div>
                            <div class="test-models">${combination.model1.name} vs ${combination.model2.name}</div>
                        </div>
                        <div class="test-status">
                            <div class="status-text">${statusText}</div>
                            ${hasAnswer ? `<div class="selected-model">é€‰æ‹©: ${selectedModel}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            return testListHTML;
        }

        function closeDetailedTestModal() {
            const modal = document.getElementById('detailedTestModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function showTestDetailSelector() {
            // åˆ›å»ºæµ‹è¯•è¯¦æƒ…é€‰æ‹©ç•Œé¢
            const modalHTML = `
                <div class="test-detail-modal" id="testDetailModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>ğŸ“‹ æµ‹è¯•è¯¦æƒ…æŸ¥çœ‹</h3>
                            <button class="close-btn" onclick="closeTestDetailModal()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="test-navigation">
                                <h4>é€‰æ‹©è¦æŸ¥çœ‹çš„æµ‹è¯•é¢˜ç›®ï¼š</h4>
                                <div class="test-list" id="testList">
                                    ${generateTestList()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
            if (!document.getElementById('testDetailModal')) {
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('testDetailModal').style.display = 'block';
        }

        function generateTestList() {
            let testListHTML = '';
            
            testData.testCombinations.forEach((combination, index) => {
                const combinationKey = `${combination.testId}_${combination.model1.index}_${combination.model2.index}`;
                const hasAnswer = testData.userPreferences[combinationKey];
                const statusClass = hasAnswer ? 'completed' : 'incomplete';
                const statusText = hasAnswer ? 'âœ… å·²å®Œæˆ' : 'â³ æœªå®Œæˆ';
                const selectedModel = hasAnswer ? testData.userPreferences[combinationKey].selectedModelName : 'æœªé€‰æ‹©';
                
                testListHTML += `
                    <div class="test-item ${statusClass}" onclick="navigateToTest(${index})">
                        <div class="test-info">
                            <div class="test-number">é¢˜ç›® ${index + 1}</div>
                            <div class="test-id">ID: ${combination.testId}</div>
                            <div class="test-models">${combination.model1.name} vs ${combination.model2.name}</div>
                        </div>
                        <div class="test-status">
                            <div class="status-text">${statusText}</div>
                            ${hasAnswer ? `<div class="selected-model">é€‰æ‹©: ${selectedModel}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            return testListHTML;
        }

        function navigateToTest(index) {
            // å…³é—­æ¨¡æ€æ¡†
            closeTestDetailModal();
            
            // è®¾ç½®å½“å‰é¢˜ç›®ç´¢å¼•
            testData.currentIndex = index;
            
            // åˆ‡æ¢åˆ°æµ‹è¯•é¡µé¢
            resultsSection.style.display = 'none';
            testSection.style.display = 'block';
            
            // åŠ è½½æŒ‡å®šé¢˜ç›®
            loadCurrentQuestion();
        }

        function closeTestDetailModal() {
            const modal = document.getElementById('testDetailModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function goHome() {
            if (confirm('ç¡®å®šè¦å›åˆ°å¼€å§‹ç•Œé¢å—ï¼Ÿå½“å‰æµ‹è¯•è¿›åº¦å·²ä¿å­˜ã€‚')) {
                // æ˜¾ç¤ºæ ‡é¢˜åŒºåŸŸ
                document.querySelector('.header').style.display = 'block';
                
                // æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
                uploadSection.style.display = 'block';
                testSection.style.display = 'none';
                resultsSection.style.display = 'none';
                
                // ä¸é‡ç½®currentTestKeyï¼Œä¿æŒç¼“å­˜ä¿¡æ¯æ˜¾ç¤º
                // currentTestKey = null;
                updateCacheInfo();
            }
        }

        function showDetailedResults() {
            const modelStats = calculateModelStats();
            let detailsHTML = '<h3>ğŸ“Š è¯¦ç»†æµ‹è¯•ç»“æœ</h3>';
            
            // æ¨¡å‹è¯¦ç»†ç»Ÿè®¡
            detailsHTML += '<div class="detailed-stats">';
            Object.entries(modelStats).forEach(([modelName, stats]) => {
                detailsHTML += `
                    <div class="model-detail">
                        <h4>${modelName}</h4>
                        <p>èƒœç‡: ${stats.winRate}</p>
                        <p>èƒœåˆ©æ¬¡æ•°: ${stats.wins}/${stats.total}</p>
                        <p>å‚ä¸å¯¹æ¯”: ${stats.total} æ¬¡</p>
                    </div>
                `;
            });
            detailsHTML += '</div>';
            
            // ç”¨æˆ·é€‰æ‹©è¯¦æƒ…
            detailsHTML += '<h3>ğŸ¯ ç”¨æˆ·é€‰æ‹©è¯¦æƒ…</h3>';
            detailsHTML += '<div class="choice-details">';
            Object.entries(testData.userPreferences).forEach(([key, pref]) => {
                detailsHTML += `
                    <div class="choice-item">
                        <p><strong>é¢˜ç›® ${pref.testId}:</strong> ${pref.model1Name} vs ${pref.model2Name}</p>
                        <p>é€‰æ‹©: ${pref.selectedModelName}</p>
                        <p>æ—¶é—´: ${new Date(pref.timestamp).toLocaleString()}</p>
                    </div>
                `;
            });
            detailsHTML += '</div>';
            
            alert('è¯¦ç»†ç»“æœå·²å‡†å¤‡ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º');
            console.log('è¯¦ç»†æµ‹è¯•ç»“æœ:', detailsHTML);
            console.log('æ¨¡å‹ç»Ÿè®¡:', modelStats);
            console.log('ç”¨æˆ·é€‰æ‹©:', testData.userPreferences);
        }

        document.getElementById('exportBtn').onclick = exportResults;

        function exportResults() {
            // æ›´æ–°ELOè¯„åˆ†
            eloSystem.updateFromPreferences(testData.userPreferences, outputModels);
            const eloRankings = eloSystem.getAllRatings().sort((a, b) => b.rating - a.rating);
            
            // æå–è¾“å…¥ä¿¡æ¯
            const inputInfo = {};
            Object.keys(testData.inputData).forEach(testId => {
                if (testId !== 'test_info') { // è·³è¿‡test_infoå­—æ®µ
                    const inputItem = testData.inputData[testId];
                    inputInfo[testId] = {
                        actionId: inputItem.action_id || null,
                        threadId: inputItem.thread_id || null,
                        testId: inputItem.test_id || testId,
                        testCase: inputItem.test_case || null
                    };
                }
            });
            
            const results = {
                testInfo: {
                    timestamp: new Date().toISOString(),
                    totalQuestions: testData.totalQuestions,
                    outputModels: outputModels,
                    completionRate: calculateStats().completionRate
                },
                inputInfo: inputInfo,
                userPreferences: testData.userPreferences,
                modelStats: calculateModelStats(),
                eloRankings: eloRankings.map((item, index) => ({
                    rank: index + 1,
                    model: item.model,
                    eloRating: item.rating
                }))
            };

            const dataStr = JSON.stringify(results, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `blind_test_results_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert('ç»“æœå·²å¯¼å‡ºï¼');
        }

        function calculateStats() {
            const totalQuestions = testData.totalQuestions;
            const completedQuestions = Object.keys(testData.userPreferences).length;
            const completionRate = totalQuestions > 0 ? Math.round((completedQuestions / totalQuestions) * 100) : 0;
            
            // ä¿®å¤å¯¹æ¯”æ¨¡å‹æ•°è®¡ç®—ï¼šä½¿ç”¨outputModelsæ•°ç»„é•¿åº¦
            const outputModelsCount = outputModels.length;

            return {
                totalQuestions,
                completedQuestions,
                completionRate,
                outputModels: outputModelsCount
            };
        }

        function calculateModelStats() {
            const modelStats = {};
            
            // åˆå§‹åŒ–æ‰€æœ‰æ¨¡å‹çš„ç»Ÿè®¡
            outputModels.forEach(model => {
                modelStats[model] = { wins: 0, total: 0, comparisons: [] };
            });

            // ç»Ÿè®¡æ¯ä¸ªå¯¹æ¯”çš„ç»“æœ
            Object.values(testData.userPreferences).forEach(pref => {
                if (pref.selectedModelName) {
                    modelStats[pref.selectedModelName].wins++;
                    modelStats[pref.selectedModelName].comparisons.push({
                        testId: pref.testId,
                        opponent: pref.selectedModelName === pref.model1Name ? pref.model2Name : pref.model1Name,
                        result: 'win'
                    });
                    
                    // è®°å½•å¯¹æ‰‹çš„å¤±è´¥
                    const opponent = pref.selectedModelName === pref.model1Name ? pref.model2Name : pref.model1Name;
                    modelStats[opponent].comparisons.push({
                        testId: pref.testId,
                        opponent: pref.selectedModelName,
                        result: 'lose'
                    });
                }
            });

            // è®¡ç®—æ€»å¯¹æ¯”æ¬¡æ•°å’Œèƒœç‡
            Object.keys(modelStats).forEach(model => {
                const comparisons = modelStats[model].comparisons;
                modelStats[model].total = comparisons.length;
                modelStats[model].winRate = modelStats[model].total > 0 ? 
                    (modelStats[model].wins / modelStats[model].total * 100).toFixed(1) + '%' : '0%';
            });

            return modelStats;
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('AIæ¨¡å‹ç›²æµ‹å¹³å°å·²åŠ è½½');
            updateCacheInfo();
        });

        function showMediaModal(url, type, title) {
            const modalMedia = document.getElementById('modalMedia');
            const modalTitle = document.getElementById('modalTitle');

            if (type === 'video') {
                modalMedia.innerHTML = `
                    <video src="${url}" controls style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                    </video>
                `;
            } else {
                // å…ˆæ˜¾ç¤ºç¼©ç•¥å›¾
                const thumbnailUrl = `${url}?x-oss-process=image/format,webp,image/resize,w_512,h_512`;
                modalMedia.innerHTML = `
                    <img id="modalImg" src="${thumbnailUrl}" style="max-width: 100%; max-height: 70vh; object-fit: contain; filter: blur(0.2px); transition: filter 0.3s;" alt="${title}">
                `;
                // åå°åŠ è½½åŸå›¾ï¼ŒåŠ è½½å®Œåæ›¿æ¢srcå¹¶å»é™¤æ¨¡ç³Š
                const img = new Image();
                img.onload = function() {
                    const modalImg = document.getElementById('modalImg');
                    if (modalImg) {
                        modalImg.src = url;
                        modalImg.style.filter = 'none';
                    }
                };
                img.onerror = function() {
                    // åŠ è½½å¤±è´¥æ—¶ä¿æŒç¼©ç•¥å›¾å¹¶å»é™¤æ¨¡ç³Š
                    const modalImg = document.getElementById('modalImg');
                    if (modalImg) {
                        modalImg.style.filter = 'none';
                    }
                };
                img.src = url;
            }

            // ä½¿ç”¨é€šç”¨æ ‡é¢˜ï¼Œä¸æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯
            modalTitle.textContent = 'åª’ä½“é¢„è§ˆ';
            document.getElementById('mediaModal').style.display = 'block';
        }

        function closeMediaModal() {
            document.getElementById('mediaModal').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('mediaModal');
            if (event.target === modal) {
                closeMediaModal();
            }
        }

        // é”®ç›˜äº‹ä»¶å¤„ç†å‡½æ•°
        function handleKeyDown(event) {
            // åªåœ¨æµ‹è¯•ç•Œé¢æ—¶å“åº”é”®ç›˜äº‹ä»¶
            if (testSection.style.display === 'none') {
                return;
            }

            // å¦‚æœæ¨¡æ€æ¡†æ‰“å¼€ï¼Œä¸å“åº”é”®ç›˜äº‹ä»¶
            if (document.getElementById('mediaModal').style.display === 'block') {
                return;
            }

            // å¦‚æœæ–‡æœ¬æ¡†èšç„¦ï¼Œä¸å“åº”é”®ç›˜äº‹ä»¶ï¼ˆé™¤äº†æ–¹å‘é”®ï¼‰
            const activeElement = document.activeElement;
            if (activeElement && activeElement.id === 'preferenceReason') {
                // åœ¨æ–‡æœ¬æ¡†ä¸­ï¼Œåªå…è®¸æ–¹å‘é”®å’ŒTabé”®
                if (event.key === 'ArrowLeft' || event.key === 'ArrowRight' || 
                    event.key === 'ArrowUp' || event.key === 'ArrowDown' || 
                    event.key === 'Tab') {
                    return; // å…è®¸é»˜è®¤è¡Œä¸º
                }
                // å…¶ä»–æŒ‰é”®ï¼ˆåŒ…æ‹¬Enterï¼‰åœ¨æ–‡æœ¬æ¡†ä¸­ä¸è§¦å‘æµ‹è¯•åŠŸèƒ½
                return;
            }

            switch(event.key) {
                case 'ArrowLeft':
                    event.preventDefault();
                    // å·¦æ–¹å‘é”®ï¼šé€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹
                    selectOutputByIndex(0);
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    // å³æ–¹å‘é”®ï¼šé€‰æ‹©ç¬¬äºŒä¸ªé€‰é¡¹
                    selectOutputByIndex(1);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    // ä¸Šæ–¹å‘é”®ï¼šä¸Šä¸€é¢˜
                    if (testData.currentIndex > 0) {
                        testData.currentIndex--;
                        loadCurrentQuestion();
                    }
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    // ä¸‹æ–¹å‘é”®ï¼šä¸‹ä¸€é¢˜
                    const currentCombination = testData.testCombinations[testData.currentIndex];
                    const combinationKey = `${currentCombination.testId}_${currentCombination.model1.index}_${currentCombination.model2.index}`;
                    
                    if (testData.userPreferences[combinationKey]) {
                        if (testData.currentIndex < testData.totalQuestions - 1) {
                            testData.currentIndex++;
                            loadCurrentQuestion();
                        } else {
                            // æœ€åä¸€é¢˜ï¼Œå®Œæˆæµ‹è¯•
                            showResults();
                        }
                    } else {
                        alert('è¯·å…ˆé€‰æ‹©å½“å‰é¢˜ç›®çš„ç­”æ¡ˆ');
                    }
                    break;
                case 'Enter':
                    event.preventDefault();
                    // å¦‚æœå½“å‰é¢˜ç›®å·²é€‰æ‹©ï¼Œè¿›å…¥ä¸‹ä¸€é¢˜
                    const currentCombinationEnter = testData.testCombinations[testData.currentIndex];
                    const combinationKeyEnter = `${currentCombinationEnter.testId}_${currentCombinationEnter.model1.index}_${currentCombinationEnter.model2.index}`;
                    if (testData.userPreferences[combinationKeyEnter]) {
                        document.getElementById('nextBtn').click();
                    }
                    break;
            }
        }

        // æ ¹æ®ç´¢å¼•é€‰æ‹©è¾“å‡º
        function selectOutputByIndex(index) {
            const outputItems = document.querySelectorAll('.output-item');
            if (index < outputItems.length) {
                const outputItem = outputItems[index];
                const modelIndex = parseInt(outputItem.dataset.modelIndex);
                selectOutput(outputItem, modelIndex);
            }
        }

        // ç”Ÿæˆæµ‹è¯•çš„å”¯ä¸€æ ‡è¯†
        function generateTestKey(inputData, outputData) {
            // ä½¿ç”¨ç®€å•çš„å­—ç¬¦ä¸²æ‹¼æ¥å’Œå“ˆå¸Œæ¥ç”Ÿæˆå”¯ä¸€æ ‡è¯†
            const inputStr = JSON.stringify(inputData);
            const outputStr = outputData.map(output => 
                output.name + JSON.stringify(output.data)
            ).join('|');
            
            // ç®€å•çš„å“ˆå¸Œå‡½æ•°
            function simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
                }
                return Math.abs(hash).toString(36);
            }
            
            const inputHash = simpleHash(inputStr).slice(0, 8);
            const outputHash = simpleHash(outputStr).slice(0, 8);
            
            return `test_${inputHash}_${outputHash}`;
        }

        // ä¿å­˜æµ‹è¯•è¿›åº¦åˆ°æœ¬åœ°å­˜å‚¨
        function saveTestProgress() {
            if (!currentTestKey) return;
            
            const progress = {
                testKey: currentTestKey,
                currentIndex: testData.currentIndex,
                userPreferences: testData.userPreferences,
                totalQuestions: testData.totalQuestions,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem(`wob_progress_${currentTestKey}`, JSON.stringify(progress));
            updateCacheInfo();
        }

        // æ¸…é™¤ç‰¹å®šæµ‹è¯•çš„ç¼“å­˜
        function clearTestCache(testKey) {
            localStorage.removeItem(`wob_progress_${testKey}`);
            updateCacheInfo();
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æµ‹è¯•è¿›åº¦
        function loadTestProgress(testKey) {
            const savedProgress = localStorage.getItem(`wob_progress_${testKey}`);
            if (savedProgress) {
                try {
                    const progress = JSON.parse(savedProgress);
                    testData.currentIndex = progress.currentIndex || 0;
                    testData.userPreferences = progress.userPreferences || {};
                    testData.totalQuestions = progress.totalQuestions || 0;
                    return true;
                } catch (error) {
                    console.error('åŠ è½½ç¼“å­˜å¤±è´¥:', error);
                }
            }
            return false;
        }

        // æ›´æ–°ç¼“å­˜ä¿¡æ¯æ˜¾ç¤º
        function updateCacheInfo() {
            const cacheInfo = document.getElementById('cacheInfo');
            if (!currentTestKey) {
                cacheInfo.innerHTML = 'æš‚æ— ç¼“å­˜æ•°æ®';
                return;
            }

            const savedProgress = localStorage.getItem(`wob_progress_${currentTestKey}`);
            if (savedProgress) {
                try {
                    const progress = JSON.parse(savedProgress);
                    const completedCount = Object.keys(progress.userPreferences || {}).length;
                    const completionRate = progress.totalQuestions > 0 ? 
                        Math.round((completedCount / progress.totalQuestions) * 100) : 0;
                    
                    cacheInfo.innerHTML = `
                        <strong>å½“å‰æµ‹è¯•è¿›åº¦:</strong> ${completedCount}/${progress.totalQuestions} (${completionRate}%)<br>
                        <small>æœ€åæ›´æ–°: ${new Date(progress.timestamp).toLocaleString()}</small>
                    `;
                } catch (error) {
                    cacheInfo.innerHTML = 'ç¼“å­˜æ•°æ®æŸå';
                }
            } else {
                cacheInfo.innerHTML = 'æš‚æ— ç¼“å­˜æ•°æ®';
            }
        }

        // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
        function clearAllCache() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æµ‹è¯•ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ä¿å­˜çš„æµ‹è¯•è¿›åº¦ã€‚')) {
                const keys = Object.keys(localStorage);
                const wobKeys = keys.filter(key => key.startsWith('wob_progress_'));
                wobKeys.forEach(key => localStorage.removeItem(key));
                
                alert('æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤ï¼');
                updateCacheInfo();
                
                // å¦‚æœå½“å‰åœ¨æµ‹è¯•ä¸­ï¼Œé‡ç½®è¿›åº¦
                if (testSection.style.display !== 'none') {
                    testData.currentIndex = 0;
                    testData.userPreferences = {};
                    loadCurrentQuestion();
                }
            }
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰å¯æ¢å¤çš„æµ‹è¯•
        function checkForResumableTest(inputData, outputData) {
            const testKey = generateTestKey(inputData, outputData);
            const savedProgress = localStorage.getItem(`wob_progress_${testKey}`);
            
            if (savedProgress) {
                try {
                    const progress = JSON.parse(savedProgress);
                    const completedCount = Object.keys(progress.userPreferences || {}).length;
                    
                    if (completedCount > 0) {
                        if (completedCount < progress.totalQuestions) {
                            // æœªå®Œæˆçš„æµ‹è¯•
                            const shouldContinue = confirm(`å‘ç°æœªå®Œæˆçš„æµ‹è¯•è¿›åº¦ (${completedCount}/${progress.totalQuestions})ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`);
                            return shouldContinue; // è¿”å›ç”¨æˆ·çš„é€‰æ‹©
                        } else {
                            // å·²å®Œæˆçš„æµ‹è¯•
                            const choice = confirm(`å‘ç°å·²å®Œæˆçš„æµ‹è¯• (${completedCount}/${progress.totalQuestions})ï¼

é€‰æ‹©"ç¡®å®š"æŸ¥çœ‹æµ‹è¯•ç»“æœ
é€‰æ‹©"å–æ¶ˆ"é‡æ–°å¼€å§‹æµ‹è¯•`);
                            if (choice) {
                                // ç”¨æˆ·é€‰æ‹©æŸ¥çœ‹ç»“æœï¼Œç›´æ¥åŠ è½½æ•°æ®å¹¶æ˜¾ç¤ºç»“æœé¡µé¢
                                testData.inputData = inputData;
                                testData.outputData = outputData;
                                testData.userPreferences = progress.userPreferences;
                                testData.totalQuestions = progress.totalQuestions;
                                testData.currentIndex = 0;
                                testData.isImportedResult = false; // é‡ç½®å¯¼å…¥ç»“æœæ ‡è®°
                                
                                // è®¾ç½®è¾“å‡ºæ¨¡å‹
                                outputModels = outputData.map(item => item.name);
                                
                                // ç”Ÿæˆæµ‹è¯•ç»„åˆï¼ˆç”¨äºç»Ÿè®¡è®¡ç®—ï¼‰
                                const validTestIds = validateData(inputData, outputData);
                                testData.testCombinations = generateTestCombinations(outputData, validTestIds);
                                
                                // ç›´æ¥æ˜¾ç¤ºç»“æœé¡µé¢
                                uploadSection.style.display = 'none';
                                testSection.style.display = 'none';
                                resultsSection.style.display = 'block';
                                
                                // æ˜¾ç¤ºæ ‡é¢˜åŒºåŸŸ
                                document.querySelector('.header').style.display = 'block';
                                
                                // æ˜¾ç¤ºç»“æœ
                                displayResults();
                                return 'completed'; // è¿”å›ç‰¹æ®Šå€¼ï¼Œè¡¨ç¤ºå·²å¤„ç†å®Œæˆæµ‹è¯•
                            } else {
                                // ç”¨æˆ·é€‰æ‹©é‡æ–°å¼€å§‹ï¼Œæ¸…ç©ºç¼“å­˜
                                clearTestCache(testKey);
                                return false; // é‡æ–°å¼€å§‹æµ‹è¯•
                            }
                        }
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥ç¼“å­˜å¤±è´¥:', error);
                }
            }
            return false; // æ²¡æœ‰ç¼“å­˜ï¼Œå¼€å§‹æ–°æµ‹è¯•
        }

        // ELOè¯„åˆ†ç³»ç»Ÿ
        class EloRating {
            constructor(kFactor = 32) {
                this.kFactor = kFactor;
                this.ratings = new Map();
                this.initialRating = 1500;
            }

            // è·å–æˆ–åˆå§‹åŒ–æ¨¡å‹è¯„åˆ†
            getRating(modelName) {
                if (!this.ratings.has(modelName)) {
                    this.ratings.set(modelName, this.initialRating);
                }
                return this.ratings.get(modelName);
            }

            // è®¡ç®—æœŸæœ›èƒœç‡
            getExpectedScore(ratingA, ratingB) {
                return 1 / (1 + Math.pow(10, (ratingB - ratingA) / 400));
            }

            // æ›´æ–°è¯„åˆ†
            updateRating(winner, loser) {
                const ratingWinner = this.getRating(winner);
                const ratingLoser = this.getRating(loser);
                
                const expectedWinner = this.getExpectedScore(ratingWinner, ratingLoser);
                const expectedLoser = this.getExpectedScore(ratingLoser, ratingWinner);
                
                const newRatingWinner = ratingWinner + this.kFactor * (1 - expectedWinner);
                const newRatingLoser = ratingLoser + this.kFactor * (0 - expectedLoser);
                
                this.ratings.set(winner, newRatingWinner);
                this.ratings.set(loser, newRatingLoser);
                
                return {
                    winner: { old: ratingWinner, new: newRatingWinner, change: newRatingWinner - ratingWinner },
                    loser: { old: ratingLoser, new: newRatingLoser, change: newRatingLoser - ratingLoser }
                };
            }

            // è·å–æ‰€æœ‰è¯„åˆ†
            getAllRatings() {
                return Array.from(this.ratings.entries()).map(([model, rating]) => ({
                    model,
                    rating: Math.round(rating)
                }));
            }

            // æ ¹æ®ç”¨æˆ·é€‰æ‹©æ›´æ–°è¯„åˆ†
            updateFromPreferences(userPreferences, outputModels) {
                // é‡ç½®è¯„åˆ†
                this.ratings.clear();
                
                // åˆå§‹åŒ–æ‰€æœ‰æ¨¡å‹çš„è¯„åˆ†
                outputModels.forEach(model => {
                    this.ratings.set(model, this.initialRating);
                });
                
                // æ ¹æ®ç”¨æˆ·é€‰æ‹©æ›´æ–°è¯„åˆ†
                Object.values(userPreferences).forEach(pref => {
                    if (pref.selectedModelName) {
                        const winner = pref.selectedModelName;
                        const loser = winner === pref.model1Name ? pref.model2Name : pref.model1Name;
                        this.updateRating(winner, loser);
                    }
                });
            }
        }

        // å…¨å±€ELOè¯„åˆ†å®ä¾‹
        let eloSystem = new EloRating();

        function updateEloRanking() {
            const eloContainer = document.getElementById('eloContainer');
            
            // æ›´æ–°ELOè¯„åˆ†
            eloSystem.updateFromPreferences(testData.userPreferences, outputModels);
            
            // è·å–æ’åºåçš„è¯„åˆ†
            const rankings = eloSystem.getAllRatings()
                .sort((a, b) => b.rating - a.rating);
            
            if (rankings.length === 0) {
                eloContainer.innerHTML = '<p style="text-align: center; color: #718096;">æš‚æ— è¯„åˆ†æ•°æ®</p>';
                return;
            }
            
            let eloHTML = '';
            rankings.forEach((item, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : 'rank-other';
                
                eloHTML += `
                    <div class="elo-item">
                        <div class="elo-rank">
                            <div class="rank-number ${rankClass}">${rank}</div>
                            <div class="model-name">${item.model}</div>
                        </div>
                        <div class="elo-score">
                            <div class="score-value">${item.rating}</div>
                        </div>
                    </div>
                `;
            });
            
            eloContainer.innerHTML = eloHTML;
        }

        // ä¿å­˜åå¥½åŸå› 
        function savePreferenceReason() {
            const currentCombination = testData.testCombinations[testData.currentIndex];
            const combinationKey = `${currentCombination.testId}_${currentCombination.model1.index}_${currentCombination.model2.index}`;
            const reasonText = document.getElementById('preferenceReason').value.trim();
            
            // å¦‚æœå­˜åœ¨ç”¨æˆ·åå¥½è®°å½•ï¼Œåˆ™æ›´æ–°åå¥½åŸå› 
            if (testData.userPreferences[combinationKey]) {
                testData.userPreferences[combinationKey].preferenceReason = reasonText || "";
            } else {
                // å¦‚æœè¿˜æ²¡æœ‰é€‰æ‹©ç­”æ¡ˆï¼Œå…ˆåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„åå¥½è®°å½•æ¥ä¿å­˜åŸå› 
                testData.userPreferences[combinationKey] = {
                    testId: currentCombination.testId,
                    model1Name: currentCombination.model1.name,
                    model2Name: currentCombination.model2.name,
                    selectedModelIndex: null,
                    selectedModelName: null,
                    preferenceReason: reasonText || "",
                    timestamp: new Date().toISOString()
                };
            }
            
            // è‡ªåŠ¨ä¿å­˜è¿›åº¦
            saveTestProgress();
        }

        // åŠ è½½åå¥½åŸå› 
        function loadPreferenceReason() {
            const currentCombination = testData.testCombinations[testData.currentIndex];
            const combinationKey = `${currentCombination.testId}_${currentCombination.model1.index}_${currentCombination.model2.index}`;
            const reasonTextarea = document.getElementById('preferenceReason');
            
            // æ¸…ç©ºæ–‡æœ¬æ¡†
            reasonTextarea.value = '';
            
            // ä»userPreferencesä¸­åŠ è½½å·²ä¿å­˜çš„åå¥½åŸå› 
            if (testData.userPreferences[combinationKey] && testData.userPreferences[combinationKey].preferenceReason) {
                reasonTextarea.value = testData.userPreferences[combinationKey].preferenceReason;
            }
        }

        function showImportedResultDetails() {
            // åˆ›å»ºå¯¼å…¥ç»“æœè¯¦æƒ…æ¨¡æ€æ¡†
            const modalHTML = `
                <div class="test-detail-modal" id="importedResultModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>ğŸ“‹ å¯¼å…¥ç»“æœè¯¦æƒ…</h3>
                            <button class="close-btn" onclick="closeImportedResultModal()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="imported-result-details">
                                <h4>ğŸ“Š æµ‹è¯•æ¦‚è§ˆ</h4>
                                <div class="result-overview">
                                    <p><strong>æ€»é¢˜ç›®æ•°:</strong> ${testData.totalQuestions}</p>
                                    <p><strong>å‚ä¸æ¨¡å‹:</strong> ${outputModels.join(', ')}</p>
                                    <p><strong>å®Œæˆæ—¶é—´:</strong> ${testData.userPreferences[Object.keys(testData.userPreferences)[0]]?.timestamp ? new Date(testData.userPreferences[Object.keys(testData.userPreferences)[0]].timestamp).toLocaleString() : 'æœªçŸ¥'}</p>
                                </div>
                                
                                <h4>ğŸ¯ ç”¨æˆ·é€‰æ‹©è¯¦æƒ…</h4>
                                <div class="choice-details">
                                    ${generateImportedChoiceDetails()}
                                </div>
                                
                                <div class="imported-result-note">
                                    <p><strong>æ³¨æ„:</strong> ç”±äºè¿™æ˜¯å¯¼å…¥çš„å†å²ç»“æœï¼Œæ— æ³•æŸ¥çœ‹å…·ä½“çš„è¾“å…¥è¾“å‡ºå†…å®¹ã€‚å¦‚éœ€æŸ¥çœ‹å®Œæ•´æµ‹è¯•å†…å®¹ï¼Œè¯·ä½¿ç”¨åŸå§‹è¾“å…¥å’Œè¾“å‡ºæ–‡ä»¶é‡æ–°è¿›è¡Œæµ‹è¯•ã€‚</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
            if (!document.getElementById('importedResultModal')) {
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('importedResultModal').style.display = 'block';
        }

        function generateImportedChoiceDetails() {
            let detailsHTML = '';
            
            // æŒ‰æ—¶é—´æ’åºç”¨æˆ·é€‰æ‹©
            const sortedPreferences = Object.entries(testData.userPreferences)
                .sort((a, b) => new Date(a[1].timestamp) - new Date(b[1].timestamp));
            
            sortedPreferences.forEach(([key, pref], index) => {
                const testNumber = index + 1;
                const choiceTime = new Date(pref.timestamp).toLocaleString();
                const preferenceReason = pref.preferenceReason || 'æ— ';
                
                detailsHTML += `
                    <div class="choice-item">
                        <div class="choice-header">
                            <span class="choice-number">é¢˜ç›® ${testNumber}</span>
                            <span class="choice-time">${choiceTime}</span>
                        </div>
                        <div class="choice-content">
                            <p><strong>æµ‹è¯•ID:</strong> ${pref.testId}</p>
                            <p><strong>å¯¹æ¯”æ¨¡å‹:</strong> ${pref.model1Name} vs ${pref.model2Name}</p>
                            <p><strong>é€‰æ‹©ç»“æœ:</strong> <span class="selected-model-highlight">${pref.selectedModelName}</span></p>
                            <p><strong>é€‰æ‹©åŸå› :</strong> ${preferenceReason}</p>
                        </div>
                    </div>
                `;
            });
            
            return detailsHTML;
        }

        function closeImportedResultModal() {
            const modal = document.getElementById('importedResultModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>